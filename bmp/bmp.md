# BMP格式

## 简介

BMP文件的数据格式按照从文件头开始的先后顺序分为四个部分：

* bmp文件头(bmp file header) : 提供文件的格式、大小等信息
* 位图信息头(bitmap infomation) : 提供图像数据的尺寸、位平面数、压缩方式、颜色索引等信息
* 调色板(color palette) : 可选，如果用索引来表示图像，调色板就是索引与其对应的颜色的映射表
* 位图数据(bitmap data) : 图像数据

|数据段名称|大小|
|:---:|:---:|
|bmp文件头|14|
|位图信息头|40|
|调色板|由颜色索引数决定|
|位图数据|由图像尺寸决定|

一般常见的图像有:

* 32位，即R\G\B\A各占8个bit表示，A标示透明度，这种情况不需要调色板。
* 24位，即R\G\B各占8个bit表示，这种图像我们称之为真彩图，这种情况不需要调色板。
* 16位，RGB565等多种格式，需要调色板
* 8位， 需要调色板
* 4位， 需要调色板
* 1位， 黑白图像

## bmp文件头

|变量名|地址偏移|大小|作用|
|:---:|:---:|:---:|:---:|
|bfType|0000h|2bytes|"BM"|
|bfSize|0002h|4bytes|说明位图文件的大小，用字节为单位|
|bfReserved1|0006h|2bytes|保留，必须设置为0|
|bfReserved2|0008h|2bytes|保留，必须设置为0|
|bfOffBits|000Ah|4bytes|说明从文件头开始到实际的图像数据之间的字节偏移，这个参数非常重要，因为调色板的长度不同会不同|

## 位图信息头

|变量名|地址偏移|大小|作用|
|:---:|:---:|:---:|:---|
|biSize|000Eh|4 bytes|位图信息结构体所需要的字节数|
|biWidth|0012h|4 bytes|图像的宽度，单位为像素|
|biHeight|0016h|4 bytes|说明图像的高度，以像素为单位，此外，还表示图像是正向的位图还是倒向的位图，>0表示是倒向的位图|
|biPlanes|001Ah|2 bytes| 为目标设备说明颜色平面数，总设置为1|
|biBitCount|001Ch| 2 bytes| 说明 比特数/像素 ，其值为1、4、8、16、24或者32|
|biCompression|001Eh|4 bytes|说明图像压缩的类型，<br>-0 BI_RGB 不压缩<br>-1 BI_BLE8 8比特游程编码，只用于8位位图<br>-2 BI_BLE4 4比特游程编码，只适用于4位位图<br>-3 BI_BITFIELDS 比特域，用于16/32位位图<br>-4 BI_JPEG JPEG位图含JPEG图像<br>-5 BI_PNG PNG 位图含PNG图像|
|biSizeImage|0022h|4 bytes|说明图像的大小，以字节为单位，当用BI_RGB时可以设置为0|
|biXPelsPerMeter|0026h|4 bytes|说明水平分辨率，用像素/米 表示，有符号整数|
|biYPelsPerMeter|0028h|4 bytes|说明垂直分辨率，用像素/米 表示，有符号整数|
|biClrUsed|002Eh|4 bytes|说明位图实际使用的彩色表中的颜色索引数，设置为0的话表示使用所有调色板项|
|biClrImportant|0032h|4 bytes|说明对图像显示有重要影响的颜色索引数|

## 调色板

调色板其实就是一个映射表，标示颜色索引号和其代表颜色的对应关系。它在文件中的布局就是一个二维数组palette[N][4],N表示总的颜色索引数
，每行的四个元素表示该索引对应的B\G\R\A的值，每个分量占一个字节，A表示不透明度，0表示不透明。
例如：一共有256中颜色，每个颜色占用4个字节，一共就是1024字节，再加上前面的文件信息头和位图信息头的54个字节一共就是1078个字节。也就是说在位图数据出现前一共有1078个字节，则文件头到位图数据区的偏移bfOffBits的值为1078

## 位图数据

后边就是位图数据了，以8位颜色深度为256的bmp图片为例，每个像素占一个字节，取得这个字节后，以该字节为索引查询调色板就能得到此点的颜色了。
